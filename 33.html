<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Stock Tracking System</title>
    
    <!-- Supabase Client Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .form-section {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="number"], input[type="text"], input[type="date"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .calculated-field {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            font-size: 1.2em !important;
            cursor: not-allowed;
        }
        
        .calculated-field::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Styles for disabled fields (past dates) */
        input[type="number"]:disabled, input[type="text"]:disabled {
            background: #f8f9fa !important;
            border-color: #dee2e6 !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        button:disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        .workflow-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            margin: 30px 0;
            border-radius: 15px;
        }
        
        .workflow-section h3 {
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .workflow-step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #f093fb;
        }
        
        .workflow-step:last-child {
            margin-bottom: 0;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .history-section {
            background: #f8f9fa;
            padding: 30px;
            margin-top: 30px;
            border-radius: 15px;
        }
        
        .history-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .history-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }
        
        .history-grid span {
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .search-section {
            background: #f0f2f5;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
        }
        
        .search-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #34495e;
        }
        
        .search-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .search-result-item:hover .click-hint {
            transform: scale(1.1);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-result-item h5 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }
        
        .click-hint {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .search-result-item p {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .help-text {
            display: block;
            margin-top: 5px;
            font-size: 0.8em;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-row .form-group {
                margin-bottom: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .container {
                margin: 10px;
            }
            
            .form-section {
                padding: 20px;
            }
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #e1e8ed;
        }
        
        .nav-tab:last-child {
            border-right: none;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Section Headers */
        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .section-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .section-header p {
            color: #6c757d;
            font-size: 1.1em;
            margin: 0;
        }
        
        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .progress-step {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .progress-step.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: white;
            transform: scale(1.05);
        }
        
        /* Form Steps */
        .form-step {
            background: white;
            margin: 20px;
            border-radius: 15px;
            border: 2px solid #e1e8ed;
            overflow: hidden;
        }
        
        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .result-item {
            text-align: center;
        }
        
        .result-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-item small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* Export Section */
        .export-options {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .export-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e1e8ed;
            text-align: center;
        }
        
        .export-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .export-card p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Status Message */
        .status-message {
            margin: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            background: #e3f2fd;
            color: #1565c0;
            font-weight: 500;
        }
        
        .status-message.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left-color: #4caf50;
        }
        
        .status-message.warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left-color: #ff9800;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left-color: #f44336;
        }
        
        /* Responsive Design for Tabs */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ Inventory Tracker</h1>
            <p>Smart Stock Management System</p>
        </div>
        
        <!-- Main Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('entry')">üìù New Entry</button>
            <button class="nav-tab" onclick="showSection('search')">üîç Search & View</button>
            <button class="nav-tab" onclick="showSection('history')">üìö History</button>
            <button class="nav-tab" onclick="showSection('export')">üìä Export</button>
        </div>

        <!-- New Entry Section -->
        <div id="entry-section" class="content-section active">
            <div class="section-header">
                <h2>üìù Create New Inventory Entry</h2>
                <p>Add a new stock record for today or a future date</p>
                <div class="progress-indicator">
                    <div class="progress-step active" data-step="1">1. Product & Date</div>
                    <div class="progress-step" data-step="2">2. Stock Details</div>
                    <div class="progress-step" data-step="3">3. Save Record</div>
                </div>
            </div>

            <div class="form-section">
                <!-- Status Message Area -->
                <div id="statusMessage" class="status-message" style="display: none;"></div>
                
                <!-- Step 1: Product & Date Selection -->
                <div class="form-step">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <h3>üéØ Select Product & Date</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">Product Name / Code</label>
                            <input type="text" id="itemName" placeholder="Enter product name or code">
                            <small class="help-text">Start typing to see existing products</small>
                        </div>
                        <div class="form-group">
                            <label for="date">Entry Date</label>
                            <input type="date" id="date" min="">
                            <small class="help-text">Today or future dates only</small>
                        </div>
                    </div>
                    
                    <!-- Warning message for past dates -->
                    <div id="dateWarning" style="display: none;"></div>
                </div>

                <!-- Step 2: Stock Input -->
                <div class="form-step">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <h3>üì¶ Enter Stock Details</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="openingStock">Opening Stock</label>
                            <input type="number" id="openingStock" placeholder="0" min="0">
                            <small class="help-text">Auto-filled from previous day's closing stock</small>
                        </div>
                        <div class="form-group">
                            <label for="newStock">New Stock Added</label>
                            <input type="number" id="newStock" placeholder="0" min="0">
                            <small class="help-text">Stock received today</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="issuedProduction">Issued to Production</label>
                            <input type="number" id="issuedProduction" placeholder="0" min="0">
                            <small class="help-text">Stock used in production</small>
                        </div>
                        <div class="form-group">
                            <label for="returns">Returns</label>
                            <input type="number" id="returns" placeholder="0" min="0">
                            <small class="help-text">Stock returned from production</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rebagging">Rebagging</label>
                            <input type="number" id="rebagging" placeholder="0" min="0">
                            <small class="help-text">Stock moved to different packaging</small>
                        </div>
                        <div class="form-group">
                            <label for="damaged">Damaged Stock</label>
                            <input type="number" id="damaged" placeholder="0" min="0">
                            <small class="help-text">Stock that cannot be used</small>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Results & Actions -->
                <div class="form-step">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <h3>üìä Results & Actions</h3>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-item">
                            <label>New Balance</label>
                            <input type="number" id="newBalance" class="calculated-field" placeholder="Auto-calculated" readonly>
                            <small>Opening + New Stock</small>
                        </div>
                        <div class="result-item">
                            <label>Closing Stock</label>
                            <input type="number" id="closingStock" class="calculated-field" placeholder="Auto-calculated" readonly>
                            <small>Final stock level</small>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="saveRecord()">üíæ Save Record</button>
                        <button class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & View Section -->
        <div id="search-section" class="content-section">
            <div class="section-header">
                <h2>üîç Search & View Products</h2>
                <p>Find existing products and view their current status</p>
            </div>
            
            <div class="search-section">
                <div class="search-row">
                    <div class="form-group">
                        <label for="searchProduct">Search by Product Name/Code</label>
                        <input type="text" id="searchProduct" placeholder="Type to search products...">
                    </div>
                    <button class="btn btn-primary" onclick="searchProduct()">üîç Search</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="content-section">
            <div class="section-header">
                <h2>üìö Recent Records</h2>
                <p>View your latest inventory entries</p>
            </div>
            
            <div id="historyContainer">
                <p style="text-align: center; color: #6c757d; margin: 20px 0;">No records saved yet. Start by adding your first inventory entry!</p>
            </div>
        </div>

        <!-- Export Section -->
        <div id="export-section" class="content-section">
            <div class="section-header">
                <h2>üìä Export Data</h2>
                <p>Download your inventory data for analysis</p>
            </div>
            
            <div class="export-options">
                <div class="export-card">
                    <h3>üìà Export All Records</h3>
                    <p>Download complete inventory history as CSV</p>
                    <button class="btn btn-success" onclick="exportData()">üìä Export All Data</button>
                </div>
                
                <div class="export-card">
                    <h3>üß™ Test Functions</h3>
                    <p>Debug and test system functionality</p>
                    <div class="test-buttons">
                        <button class="btn btn-warning" onclick="testDateChange()">üß™ Test Date Change</button>
                        <button class="btn btn-info" onclick="testTomorrow()">üìÖ Test Tomorrow</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="history-section">
            <h3>üìö Recent Records</h3>
            <div id="historyContainer">
                <p style="text-align: center; color: #6c757d; margin: 20px 0;">No records saved yet. Start by adding your first inventory entry!</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tjeougsaxfuznmquezon.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqZW91Z3NheGZ1em5tcXVlem9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjAxOTAyOTcsImV4cCI6MjAzNTc2NjI5N30.vZ2mKg4WIZSUUPt36qu9vOr4Lfm_rLkBwqMNbWvINVw';
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Set today's date by default and set minimum date
        const today = new Date();
        const dateInput = document.getElementById('date');
        dateInput.valueAsDate = today;
        dateInput.min = today.toISOString().split('T')[0]; // Set minimum date to today
        
        // Function to show status messages
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status-message ${type}`;
                statusDiv.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Function to update progress indicator
        function updateProgress() {
            const itemName = document.getElementById('itemName').value.trim();
            const date = document.getElementById('date').value;
            const openingStock = document.getElementById('openingStock').value;
            const newStock = document.getElementById('newStock').value;
            const issuedProduction = document.getElementById('issuedProduction').value;
            const returns = document.getElementById('returns').value;
            const rebagging = document.getElementById('rebagging').value;
            const damaged = document.getElementById('damaged').value;
            
            // Step 1: Product & Date
            if (itemName && date) {
                document.querySelector('[data-step="1"]').classList.add('active');
                showStatus('‚úÖ Step 1 Complete: Product and date selected', 'success');
            } else {
                document.querySelector('[data-step="1"]').classList.remove('active');
            }
            
            // Step 2: Stock Details (at least some fields filled)
            if (openingStock || newStock || issuedProduction || returns || rebagging || damaged) {
                document.querySelector('[data-step="2"]').classList.add('active');
                if (!document.querySelector('[data-step="2"]').classList.contains('was-active')) {
                    showStatus('üì¶ Step 2 Complete: Stock details entered', 'success');
                    document.querySelector('[data-step="2"]').classList.add('was-active');
                }
            } else {
                document.querySelector('[data-step="2"]').classList.remove('active');
                document.querySelector('[data-step="2"]').classList.remove('was-active');
            }
            
            // Step 3: Ready to Save (all required fields filled)
            if (itemName && date && (openingStock || newStock || issuedProduction || returns || rebagging || damaged)) {
                document.querySelector('[data-step="3"]').classList.add('active');
                if (!document.querySelector('[data-step="3"]').classList.contains('was-active')) {
                    showStatus('üéØ Ready to save! All required information entered', 'success');
                    document.querySelector('[data-step="3"]').classList.add('was-active');
                }
            } else {
                document.querySelector('[data-step="3"]').classList.remove('active');
                document.querySelector('[data-step="3"]').classList.remove('was-active');
            }
        }
        
        // Function to calculate values
        function calculateValues() {
            const opening = parseFloat(document.getElementById('openingStock').value) || 0;
            const newStockVal = parseFloat(document.getElementById('newStock').value) || 0;
            const issued = parseFloat(document.getElementById('issuedProduction').value) || 0;
            const returnsVal = parseFloat(document.getElementById('returns').value) || 0;
            const rebaggingVal = parseFloat(document.getElementById('rebagging').value) || 0;
            const damagedVal = parseFloat(document.getElementById('damaged').value) || 0;
            
            // Calculate new balance
            const newBalanceVal = opening + newStockVal;
            document.getElementById('newBalance').value = newBalanceVal;
            
            // Calculate closing stock
            const closingStockVal = newBalanceVal - issued + returnsVal + rebaggingVal - damagedVal;
            document.getElementById('closingStock').value = Math.max(0, closingStockVal); // Ensure non-negative
            
            // Visual feedback for negative closing stock
            if (closingStockVal < 0) {
                document.getElementById('closingStock').style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
                document.getElementById('closingStock').value = 0;
            } else {
                document.getElementById('closingStock').style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            }
            
            // Update progress indicator
            updateProgress();
        }
        
        // Function to get the latest closing stock for a product
        async function getLatestClosingStock(productName) {
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .eq('item_name', productName)
                    .order('date', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('Error fetching latest closing stock:', error);
                    return null;
                }
                
                if (records && records.length > 0) {
                    return records[0].closing_stock;
                }
                
                return null; // New product
            } catch (error) {
                console.error('Error in getLatestClosingStock:', error);
                return null;
            }
        }
        
        // Function to get data for a specific date and product
        async function getDataForDate(productName, targetDate) {
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .eq('item_name', productName)
                    .eq('date', targetDate)
                    .single();
                
                if (error) {
                    console.error('Error fetching data for date:', error);
                    return null;
                }
                return records;
            } catch (error) {
                console.error('Error in getDataForDate:', error);
                return null;
            }
        }
        
        // Function to calculate what opening stock should be for a given date
        async function calculateOpeningStockForDate(productName, targetDate) {
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .eq('item_name', productName)
                    .lt('date', targetDate)
                    .order('date', { ascending: false });
                
                if (error) {
                    console.error('Error calculating opening stock:', error);
                    return null;
                }
                
                if (records && records.length === 0) {
                    console.log('No previous records found before target date');
                    return null; // No previous data
                }
                
                // Get the most recent record before the target date
                const mostRecent = records[0];
                console.log('Most recent previous record date:', mostRecent.date, 'Closing stock:', mostRecent.closing_stock);
                
                // For future dates, we can use the most recent closing stock as the opening stock
                // since no transactions have happened between then and the future date
                let calculatedOpeningStock = mostRecent.closing_stock;
                
                // Walk through all records between the most recent and target date
                const intermediateRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate > new Date(mostRecent.date) && recordDate < new Date(targetDate);
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                console.log('Intermediate records found:', intermediateRecords.length);
                
                // Apply each day's transactions to calculate the opening stock for target date
                intermediateRecords.forEach(record => {
                    console.log('Processing intermediate record for date:', record.date, 'Closing stock:', record.closing_stock);
                    calculatedOpeningStock = record.closing_stock;
                });
                
                console.log('Final calculated opening stock:', calculatedOpeningStock);
                return calculatedOpeningStock;
            } catch (error) {
                console.error('Error in calculateOpeningStockForDate:', error);
                return null;
            }
        }
        
        // Function to auto-update form when date changes
        async function updateFormForDate() {
            const itemName = document.getElementById('itemName').value.trim();
            const selectedDate = document.getElementById('date').value;
            
            console.log('updateFormForDate called:', { itemName, selectedDate }); // Debug log
            
            if (!itemName || !selectedDate) {
                console.log('Missing itemName or selectedDate, returning early');
                return;
            }
            
            const targetDate = new Date(selectedDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            console.log('Target date:', targetDate, 'Today:', today); // Debug log
            
            try {
                // Check if there's existing data for this exact date
                const existingData = await getDataForDate(itemName, selectedDate);
                console.log('Existing data found:', existingData); // Debug log
                
                if (existingData) {
                    // Data exists for this date - load it completely
                    console.log('Loading existing data for date:', selectedDate);
                    document.getElementById('openingStock').value = existingData.opening_stock;
                    document.getElementById('newStock').value = existingData.new_stock;
                    document.getElementById('issuedProduction').value = existingData.issued_production;
                    document.getElementById('returns').value = existingData.returns;
                    document.getElementById('rebagging').value = existingData.rebagging;
                    document.getElementById('damaged').value = existingData.damaged;
                    
                    // Make opening stock read-only since it's existing data
                    openingStock.readOnly = true;
                    openingStock.style.background = '#e9ecef';
                    openingStock.style.cursor = 'not-allowed';
                    document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Existing data for this date)';
                    
                    calculateValues();
                    toggleFormFieldsForDate(selectedDate); // Add date restriction check
                    
                    // Show special message for past dates with existing data
                    if (isDateInPast(selectedDate)) {
                        const warningDiv = document.getElementById('dateWarning');
                        if (warningDiv) {
                            warningDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #bee5eb;"><strong>üìñ View-Only Mode:</strong> This record exists for a past date and cannot be modified. You can view the data but changes are not allowed.</div>';
                            warningDiv.style.display = 'block';
                        }
                    }
                    
                    return;
                }
                
                // No existing data for this date - calculate opening stock
                const calculatedOpeningStock = await calculateOpeningStockForDate(itemName, selectedDate);
                console.log('Calculated opening stock:', calculatedOpeningStock); // Debug log
                
                if (calculatedOpeningStock !== null) {
                    // We can calculate opening stock for this date
                    console.log('Setting calculated opening stock:', calculatedOpeningStock);
                    document.getElementById('openingStock').value = calculatedOpeningStock;
                    openingStock.readOnly = true;
                    openingStock.style.background = '#e9ecef';
                    openingStock.style.cursor = 'not-allowed';
                    
                    if (targetDate > today) {
                        document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Calculated for future date)';
                    } else {
                        document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Calculated from previous data)';
                    }
                    
                    // Clear other fields for new entry
                    document.getElementById('newStock').value = '';
                    document.getElementById('issuedProduction').value = '';
                    document.getElementById('returns').value = '';
                    document.getElementById('rebagging').value = '';
                    document.getElementById('damaged').value = '';
                    
                    calculateValues();
                    toggleFormFieldsForDate(selectedDate); // Add date restriction check
                } else {
                    // Cannot calculate opening stock (new product or no previous data)
                    console.log('Cannot calculate opening stock, allowing manual entry');
                    openingStock.readOnly = false;
                    openingStock.style.background = '#f8f9fa';
                    openingStock.style.cursor = 'text';
                    document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Set once for new product)';
                    
                    // Clear all fields
                    document.getElementById('openingStock').value = '';
                    document.getElementById('newStock').value = '';
                    document.getElementById('issuedProduction').value = '';
                    document.getElementById('returns').value = '';
                    document.getElementById('rebagging').value = '';
                    document.getElementById('damaged').value = '';
                    
                    calculateValues();
                    toggleFormFieldsForDate(selectedDate); // Add date restriction check
                }
            } catch (error) {
                console.error('Error in updateFormForDate:', error);
                // Fallback to manual entry
                openingStock.readOnly = false;
                openingStock.style.background = '#f8f9fa';
                openingStock.style.cursor = 'text';
                document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Error occurred, manual entry)';
                toggleFormFieldsForDate(selectedDate); // Add date restriction check
            }
        }
        
        // Function to check if product exists and auto-fill opening stock
        async function checkProductAndFillOpeningStock() {
            const itemName = document.getElementById('itemName').value.trim();
            if (!itemName) return;
            
            try {
                const latestClosingStock = await getLatestClosingStock(itemName);
                if (latestClosingStock !== null) {
                    // Product exists, use previous closing stock as opening stock
                    openingStock.value = latestClosingStock;
                    openingStock.readOnly = true;
                    openingStock.style.background = '#e9ecef';
                    openingStock.style.cursor = 'not-allowed';
                    document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Loaded from previous day)';
                    calculateValues();
                } else {
                    // New product, allow manual entry
                    openingStock.readOnly = false;
                    openingStock.style.background = '#f8f9fa';
                    openingStock.style.cursor = 'text';
                    document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Set once for new product)';
                }
                
                // Check date restrictions after setting up the form
                const selectedDate = document.getElementById('date').value;
                if (selectedDate) {
                    toggleFormFieldsForDate(selectedDate);
                }
            } catch (error) {
                console.error('Error checking product:', error);
                // Fallback to manual entry
                openingStock.readOnly = false;
                openingStock.style.background = '#f8f9fa';
                openingStock.style.cursor = 'text';
                document.querySelector('label[for="openingStock"]').innerHTML = 'Opening Stock (Error occurred, manual entry)';
                
                // Check date restrictions even in error case
                const selectedDate = document.getElementById('date').value;
                if (selectedDate) {
                    toggleFormFieldsForDate(selectedDate);
                }
            }
        }
        

        
        // Event listeners are now set up in DOMContentLoaded to avoid conflicts
        
        // Load saved records from localStorage
        async function loadHistory() {
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error('Error loading history:', error);
                    document.getElementById('historyContainer').innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">Error loading records. Please refresh the page.</p>';
                    return;
                }
                
                const container = document.getElementById('historyContainer');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; margin: 20px 0;">No records saved yet. Start by adding your first inventory entry!</p>';
                    return;
                }
                
                container.innerHTML = records.map(record => `
                    <div class="history-item">
                        <h4>${record.item_name} - ${record.date}</h4>
                        <div class="history-grid">
                            <span><strong>Opening:</strong> ${record.opening_stock}</span>
                            <span><strong>New Stock:</strong> ${record.new_stock}</span>
                            <span><strong>New Balance:</strong> ${record.new_balance}</span>
                            <span><strong>Issued:</strong> ${record.issued_production}</span>
                            <span><strong>Returns:</strong> ${record.returns}</span>
                            <span><strong>Rebagging:</strong> ${record.rebagging}</span>
                            <span><strong>Damaged:</strong> ${record.damaged}</span>
                            <span><strong>Closing:</strong> ${record.closing_stock}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error in loadHistory:', error);
                document.getElementById('historyContainer').innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">Error loading records. Please refresh the page.</p>';
            }
        }
        
        // Function to check if a date is in the past (previous day or earlier)
        function isDateInPast(selectedDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of today
            
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0); // Set to start of selected date
            
            return selected < today;
        }
        
        // Function to toggle form fields based on date
        function toggleFormFieldsForDate(selectedDate) {
            const isPastDate = isDateInPast(selectedDate);
            const formFields = [
                'openingStock', 'newStock', 'issuedProduction', 
                'returns', 'rebagging', 'damaged'
            ];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (isPastDate) {
                        field.disabled = true;
                        field.style.opacity = '0.6';
                        field.style.cursor = 'not-allowed';
                        field.title = 'Cannot modify data for past dates';
                    } else {
                        field.disabled = false;
                        field.style.opacity = '1';
                        field.style.cursor = 'auto';
                        field.title = '';
                    }
                }
            });
            
            // Also disable the save button for past dates
            const saveButton = document.querySelector('button[onclick="saveRecord()"]');
            if (saveButton) {
                if (isPastDate) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.6';
                    saveButton.style.cursor = 'not-allowed';
                    saveButton.title = 'Cannot modify data for past dates';
                } else {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                    saveButton.title = '';
                }
            }
            
            // Show warning message for past dates
            const warningDiv = document.getElementById('dateWarning');
            if (warningDiv) {
                if (isPastDate) {
                    warningDiv.innerHTML = '<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #ffeaa7;"><strong>‚ö†Ô∏è Read-Only Mode:</strong> This date is in the past. You cannot modify data for previous days.</div>';
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                }
            }
        }
        
        // Save record function
        async function saveRecord() {
            const itemName = document.getElementById('itemName').value;
            const date = document.getElementById('date').value;
            
            if (!itemName.trim()) {
                alert('Please enter an item name or product code.');
                return;
            }
            
            if (!date) {
                alert('Please select a date.');
                return;
            }
            
            // Check if trying to modify past data
            if (isDateInPast(date)) {
                alert('‚ùå Cannot modify data for past dates. Please select today or a future date.');
                return;
            }
            
            const record = {
                itemName: itemName.trim(),
                date: date,
                openingStock: parseFloat(document.getElementById('openingStock').value) || 0,
                newStock: parseFloat(document.getElementById('newStock').value) || 0,
                newBalance: parseFloat(document.getElementById('newBalance').value) || 0,
                issuedProduction: parseFloat(document.getElementById('issuedProduction').value) || 0,
                returns: parseFloat(document.getElementById('returns').value) || 0,
                rebagging: parseFloat(document.getElementById('rebagging').value) || 0,
                damaged: parseFloat(document.getElementById('damaged').value) || 0,
                closingStock: parseFloat(document.getElementById('closingStock').value) || 0,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Check if record already exists for this date and product
                const existingRecord = await getDataForDate(itemName, date);
                
                if (existingRecord) {
                    // Update existing record
                    const { error } = await supabaseClient
                        .from('inventory_records')
                        .update({
                            opening_stock: record.openingStock,
                            new_stock: record.newStock,
                            new_balance: record.newBalance,
                            issued_production: record.issuedProduction,
                            returns: record.returns,
                            rebagging: record.rebagging,
                            damaged: record.damaged,
                            closing_stock: record.closingStock,
                            timestamp: record.timestamp
                        })
                        .eq('id', existingRecord.id);
                    
                    if (error) {
                        console.error('Error updating record:', error);
                        alert('Error updating record. Please try again.');
                        return;
                    }
                    
                    alert('Record updated successfully! üéâ');
                } else {
                    // Insert new record
                    const { error } = await supabaseClient
                        .from('inventory_records')
                        .insert([{
                            item_name: record.itemName,
                            date: record.date,
                            opening_stock: record.openingStock,
                            new_stock: record.newStock,
                            new_balance: record.newBalance,
                            issued_production: record.issuedProduction,
                            returns: record.returns,
                            rebagging: record.rebagging,
                            damaged: record.damaged,
                            closing_stock: record.closingStock,
                            timestamp: record.timestamp
                        }]);
                    
                    if (error) {
                        console.error('Error saving record:', error);
                        alert('Error saving record. Please try again.');
                        return;
                    }
                    
                    alert('Record saved successfully! üéâ');
                }
                
                // Reload history and clear form
                await loadHistory();
                clearForm();
                
            } catch (error) {
                console.error('Error in saveRecord:', error);
                alert('Error saving record. Please try again.');
            }
        }
        
        // Clear form function
        function clearForm() {
            if (confirm('Are you sure you want to clear all fields?')) {
                document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    if (!input.readOnly) {
                        input.value = '';
                    }
                });
                
                // Clear date and set to today
                document.getElementById('date').valueAsDate = new Date();
                
                // Clear search results
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('searchProduct').value = '';
                
                // Use the new date-aware logic to update the form
                updateFormForDate();
            }
        }
        
        // Export data function
        async function exportData() {
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .order('date', { ascending: false });
                
                if (error) {
                    console.error('Error fetching records for export:', error);
                    alert('Error fetching data for export. Please try again.');
                    return;
                }
                
                if (!records || records.length === 0) {
                    alert('No data to export. Please save some records first.');
                    return;
                }
                
                // Create CSV content
                const headers = ['Date', 'Item Name', 'Opening Stock', 'New Stock', 'New Balance', 'Issued to Production', 'Returns', 'Rebagging', 'Damaged', 'Closing Stock'];
                const csvContent = [
                    headers.join(','),
                    ...records.map(record => [
                        record.date,
                        `"${record.item_name}"`,
                        record.opening_stock,
                        record.new_stock,
                        record.new_balance,
                        record.issued_production,
                        record.returns,
                        record.rebagging,
                        record.damaged,
                        record.closing_stock
                    ].join(','))
                ].join('\n');
                
                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_records_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Data exported successfully! üìä');
            } catch (error) {
                console.error('Error in exportData:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        // Search product function
        async function searchProduct() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const searchResultsDiv = document.getElementById('searchResults');
            searchResultsDiv.innerHTML = ''; // Clear previous results

            if (!searchTerm.trim()) {
                searchResultsDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 10px;">Please enter a search term.</p>';
                return;
            }

            // Show loading state
            searchResultsDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                    <p>Searching for products...</p>
                </div>
            `;
            
            try {
                const { data: records, error } = await supabaseClient
                    .from('inventory_records')
                    .select('*')
                    .or(`item_name.ilike.%${searchTerm}%`)
                    .order('date', { ascending: false });

                if (error) {
                    console.error('Error searching products:', error);
                    searchResultsDiv.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 10px;">Error searching products. Please try again.</p>';
                    return;
                }

                if (!records || records.length === 0) {
                    searchResultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 3em; margin-bottom: 10px;">üîç</div>
                            <h4>No matching products found</h4>
                            <p>Try searching with different keywords or check the spelling.</p>
                            <p><small>Tip: You can also create a new product entry in the "New Entry" tab.</small></p>
                        </div>
                    `;
                    return;
                }

                // Get unique products that match the search term
                const uniqueProducts = new Map();
                records.forEach(record => {
                    if (!uniqueProducts.has(record.item_name)) {
                        uniqueProducts.set(record.item_name, record);
                    } else {
                        // Keep the most recent record for each product
                        const existing = uniqueProducts.get(record.item_name);
                        if (new Date(record.date) > new Date(existing.date)) {
                            uniqueProducts.set(record.item_name, record);
                        }
                    }
                });

                // Convert to array and sort by most recent
                const sortedProducts = Array.from(uniqueProducts.values())
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedProducts.forEach(record => {
                    const item = document.createElement('div');
                    item.classList.add('search-result-item');
                    item.innerHTML = `
                        <div class="search-result-header">
                            <h5>${record.item_name}</h5>
                            <span class="click-hint">üëÜ Click to load into form</span>
                        </div>
                        <p><strong>Last Updated:</strong> ${record.date}</p>
                        <p><strong>Current Stock:</strong> ${record.closing_stock}</p>
                        <p><strong>Previous Entry:</strong> New Stock: ${record.new_stock} | Issued: ${record.issued_production} | Returns: ${record.returns}</p>
                        <p><strong>Status:</strong> ${record.closing_stock > 0 ? 'üü¢ In Stock' : 'üî¥ Out of Stock'}</p>
                    `;
                    item.onclick = () => {
                        // Fill the form with this product's latest data
                        document.getElementById('itemName').value = record.item_name;
                        document.getElementById('date').valueAsDate = new Date(); // Set to today
                        
                        // Clear the search results
                        searchResultsDiv.innerHTML = '';
                        document.getElementById('searchProduct').value = '';
                        
                        // Switch to the entry section
                        showSection('entry');
                        
                        // Use the new date-aware logic to update the form
                        updateFormForDate();
                        
                        // Show success message
                        showStatus(`‚úÖ Product "${record.item_name}" loaded successfully!`, 'success');
                    };
                    searchResultsDiv.appendChild(item);
                });
            } catch (error) {
                console.error('Error in searchProduct:', error);
                searchResultsDiv.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 10px;">Error searching products. Please try again.</p>';
            }
        }

        // Function to fill the form with a specific record's data
        async function fillFormWithRecord(record) {
            document.getElementById('itemName').value = record.item_name;
            document.getElementById('date').valueAsDate = new Date(record.date);
            
            // Clear the search results
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchProduct').value = '';

            // Switch to the entry section
            showSection('entry');

            // Use the new date-aware logic to update the form
            await updateFormForDate();
            
            // Show success message
            showStatus(`‚úÖ Record for "${record.item_name}" loaded successfully!`, 'success');
        }
        
        // Initialize the page
        calculateValues();
        
        // Initialize form field states based on current date
        document.addEventListener('DOMContentLoaded', function() {
            // Update minimum date to today
            const today = new Date();
            const dateInput = document.getElementById('date');
            dateInput.min = today.toISOString().split('T')[0];
            
            const currentDate = dateInput.value;
            if (currentDate) {
                toggleFormFieldsForDate(currentDate);
            }
            
            // Periodic check to ensure disabled fields stay disabled (prevents dev tools tampering)
            setInterval(function() {
                const selectedDate = document.getElementById('date').value;
                if (selectedDate) {
                    toggleFormFieldsForDate(selectedDate);
                }
            }, 2000); // Check every 2 seconds
            
            // Show entry section by default
            showSection('entry');
        });
        
        // Ensure event listeners are properly set up after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            // Set up date change listener
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    console.log('Date changed to:', this.value);
                    
                    // Prevent selecting past dates
                    if (isDateInPast(this.value)) {
                        alert('‚ùå Cannot select past dates. Please choose today or a future date.');
                        this.valueAsDate = new Date(); // Reset to today
                        return;
                    }
                    
                    updateFormForDate();
                    toggleFormFieldsForDate(this.value); // Add this line to check date restrictions
                });
                console.log('Date change listener added');
            } else {
                console.error('Date input not found');
            }
            
            // Set up item name change listener
            const itemNameInput = document.getElementById('itemName');
            if (itemNameInput) {
                itemNameInput.addEventListener('input', function() {
                    console.log('Item name changed to:', this.value);
                    checkProductAndFillOpeningStock();
                });
                console.log('Item name change listener added');
            } else {
                console.error('Item name input not found');
            }
            
            // Set up numeric input change listeners for calculations
            const numericInputs = ['openingStock', 'newStock', 'issuedProduction', 'returns', 'rebagging', 'damaged'];
            numericInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', calculateValues);
                    
                    // Add protection against editing disabled fields
                    input.addEventListener('keydown', function(e) {
                        if (this.disabled) {
                            e.preventDefault();
                            alert('‚ùå This field is locked for past dates and cannot be modified.');
                            return false;
                        }
                    });
                    
                    // Prevent pasting into disabled fields
                    input.addEventListener('paste', function(e) {
                        if (this.disabled) {
                            e.preventDefault();
                            alert('‚ùå Cannot paste into locked fields for past dates.');
                            return false;
                        }
                    });
                    
                    // Prevent dropping into disabled fields
                    input.addEventListener('drop', function(e) {
                        if (this.disabled) {
                            e.preventDefault();
                            alert('‚ùå Cannot drop content into locked fields for past dates.');
                            return false;
                        }
                    });
                    
                    console.log(`Added calculation listener to ${inputId}`);
                } else {
                    console.error(`Input ${inputId} not found`);
                }
            });
            
            // Add progress tracking for text inputs
            const textInputs = ['itemName'];
            textInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateProgress);
                }
            });
            
            // Add progress tracking for date input (using existing dateInput variable)
            if (dateInput) {
                dateInput.addEventListener('change', updateProgress);
            }
        });
        
        // Test function to debug date change functionality
        function testDateChange() {
            console.log('Test button clicked');
            console.log('Current itemName:', document.getElementById('itemName').value);
            console.log('Current date:', document.getElementById('date').value);
            console.log('Event listeners check:');
            console.log('- Date input:', document.getElementById('date'));
            console.log('- Item name input:', document.getElementById('itemName'));
            
            // Manually trigger the date change function
            updateFormForDate();
        }

        // Test function to simulate tomorrow's date
        function testTomorrow() {
            console.log('Test Tomorrow button clicked');
            const today = new Date();
            today.setDate(today.getDate() + 1);
            today.setHours(0, 0, 0, 0);
            document.getElementById('date').valueAsDate = today;
            console.log('Date set to tomorrow:', today.toISOString().split('T')[0]);
            updateFormForDate();
        }
        
        // Function to switch between tabs
        function showSection(sectionName) {
            // Show loading state
            showStatus(`üîÑ Loading ${sectionName} section...`, 'info');
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            const selectedSection = document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Activate selected tab
            const selectedTab = event.target;
            selectedTab.classList.add('active');
            
            // Load data for specific sections
            if (sectionName === 'history') {
                loadHistory();
            }
            
            // Show success message after a short delay
            setTimeout(() => {
                showStatus(`‚úÖ ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} section loaded successfully!`, 'success');
            }, 500);
        }
    </script>
</body>
</html>